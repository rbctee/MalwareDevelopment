# Creating a DDL

## Theory

In Windows, much of the functionality of the operating system is provided by DLL. Additionally, when you run a program, much of the functionality of the program may be provided by DLLs.

You can use [lucasg/Dependencies][2] to check the DLL dependencies (those that are explicit).

Two types of DLL:

1. **Load-time dynamic linking** (DLL dependency exported after the compilation)
2. **Run-time dynamic linking** (DLL loaded after the program is run, e.g. using `LoadLibrary`)

> When the entry point function returns a `FALSE` value, the application will not start if you are using load-time dynamic linking.
> 
> If you are using run-time dynamic linking, only the individual DLL will not load.

Moreover:

> The entry point function should only perform simple initialization tasks and should not call any other DLL loading or termination functions.
>
> For example, in the entry point function, you should not directly or indirectly call the `LoadLibrary` function or the `LoadLibraryEx` function.

Besides DLLs, .NET is based on the concept of `Assemblies`:

> With the introduction of **.NET** and the **.NET Framework**, most of the problems that are associated with DLLs have been eliminated by using assemblies.
>
> An `assembly` is a logical unit of functionality that runs under the control of the .NET common language runtime (CLR).
>
> An assembly physically exists as a .dll file or as an .exe file. However, internally an assembly is different from a Microsoft Win32 DLL.
>
> An assembly file contains an assembly manifest, type metadata, Microsoft intermediate language (MSIL) code, and other resources.

## Code

Example from the first ref:

```cpp
BOOL APIENTRY DllMain(
    // Handle to DLL module
    HANDLE hModule,
    // Reason for calling function
    DWORD ul_reason_for_call,
    // Reserved
    LPVOID lpReserved
) {
    switch ( ul_reason_for_call )
    {
        // A process is loading the DLL.
        case DLL_PROCESS_ATTACHED:
        break;

        // A process is creating a new thread.
        case DLL_THREAD_ATTACHED:
        break;

        // A thread exits normally.
        case DLL_THREAD_DETACH:
        break;

        // A process unloads the DLL.
        case DLL_PROCESS_DETACH:
        break;
    }

    // if it returns False, and the DLL is dynamically linked at load-time
    //      the program will fail
    return TRUE;
}
```

## References

1. [What is a DLL][1]
2. [lucasg/Dependencies][2]

[1]: <https://docs.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library>
[2]: <https://github.com/lucasg/Dependencies>